
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LaundryWatch - Yönetici Paneli</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript">
    function editRoom(no) {
      const newRoom = prompt("Yeni oda numarası girin:");
      if (newRoom) {
        db.ref("students/" + no + "/room").set(newRoom).then(() => {
          alert("Oda numarası güncellendi.");
          loadStudents();
        });
      }
    }
  </script>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js">
    function editRoom(no) {
      const newRoom = prompt("Yeni oda numarası girin:");
      if (newRoom) {
        db.ref("students/" + no + "/room").set(newRoom).then(() => {
          alert("Oda numarası güncellendi.");
          loadStudents();
        });
      }
    }
  </script>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js">
    function editRoom(no) {
      const newRoom = prompt("Yeni oda numarası girin:");
      if (newRoom) {
        db.ref("students/" + no + "/room").set(newRoom).then(() => {
          alert("Oda numarası güncellendi.");
          loadStudents();
        });
      }
    }
  </script>

  <style>
    body { font-family: sans-serif; background-color: #f8f9fa; padding: 20px; }
    h2 { margin-top: 0; }
    .notice { background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
    .card { padding: 10px; border-radius: 8px; color: white; font-weight: bold; }
    .available { background-color: #28a745; }
    .in_use { background-color: #dc3545; }
    #reader { margin-top: 20px; max-width: 400px; margin-left: auto; margin-right: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    table th, table td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    table th { background: #f0f0f0; cursor: pointer; }
    #admin-panel { display: none; margin-top: 40px; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    #admin-btn { margin-top: 30px; padding: 10px 20px; background-color: #007bff; border: none; color: white; border-radius: 5px; cursor: pointer; }
    .form-group { margin-top: 20px; }
    .form-group input { padding: 6px; margin-right: 10px; border-radius: 4px; border: 1px solid #ccc; }
    .form-group button { padding: 6px 10px; background: #28a745; border: none; color: white; border-radius: 5px; cursor: pointer; }
    .btn-delete { background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
    .btn-edit { background: #ffc107; color: black; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
    #searchStudent { margin-top: 10px; margin-bottom: 10px; padding: 6px; width: 300px; border-radius: 4px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h2>LaundryWatch</h2>
  <div class="notice">📌 Giriş için öğrenci numaranızı ve şifrenizi giriniz. 7 günde 4 kullanım hakkı tanımlıdır.</div>
  <div id="reader"></div>
  <div class="grid" id="machine-list"></div>

  <button id="admin-btn" onclick="adminLogin()">Yönetici olarak giriş yap</button>

  <div id="admin-panel">
    <h3>📋 İşlem Geçmişi (Son 100 Kayıt)</h3>
    <table id="log-table">
      <thead>
        <tr>
          <th>Makine</th>
          <th>İşlem</th>
          <th>Öğrenci No</th>
          <th>IP</th>
          <th>Tarih</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>📊 Kullanım Sayısı (7 Günlük)</h3>
    <table id="usage-table">
      <thead>
        <tr>
          <th>Öğrenci No</th>
          <th>Son 7 Gündeki Kullanım</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>➕ Yeni Öğrenci Ekle</h3>
    <div class="form-group">
      <input type="text" id="newStudentNo" placeholder="Öğrenci No">
      <input type="text" id="newStudentPassword" placeholder="Şifre">
<input type="text" id="newStudentRoom" placeholder="Oda No">
      <button onclick="addNewStudent()">Ekle</button>
    </div>

    <h3>📝 Öğrenci Listesi (Düzenle / Sil)</h3>
    <input type="text" id="searchStudent" placeholder="Öğrenci no veya şifre ara..." onkeyup="filterStudentTable()">
    <table id="student-table">
      <thead>
        <tr>
          <th onclick="sortTable(0)">Öğrenci No ⬍</th>
          <th onclick="sortTable(1)">Şifre ⬍</th>
          <th>İşlem</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDylInzc9Q1_V1NqZTt8fyLGeqOnwMT7tU",
      authDomain: "laundry-a846e.firebaseapp.com",
      databaseURL: "https://laundry-a846e-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "laundry-a846e",
      storageBucket: "laundry-a846e.appspot.com",
      messagingSenderId: "49043361685",
      appId: "1:49043361685:web:d4d98f53d8fb51fd3f69c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentStudentNo = "";
    let currentStudentIp = "";

    fetch("https://api.ipify.org?format=json")
      .then(res => res.json())
      .then(data => { currentStudentIp = data.ip; });

    function adminLogin() {
      const password = prompt("Yönetici şifresi:");
      if (password === "admin123") {
        document.getElementById("admin-panel").style.display = "block";
        loadLogs(); loadUsageStats(); loadStudents();
      } else {
        alert("Hatalı şifre!");
      }
    }

    function addNewStudent() {
      const no = document.getElementById("newStudentNo").value;
      const pass = document.getElementById("newStudentPassword").value;
      const room = document.getElementById("newStudentRoom").value;
      if (no && pass) {
        db.ref("students/" + no).set({ password: pass, room: room }).then(() => {
          alert("Öğrenci eklendi."); loadStudents();
        });
      }
    }

    function loadStudents() {
      db.ref("students").once("value").then(snapshot => {
        const students = snapshot.val() || {};
        const tbody = document.querySelector("#student-table tbody");
        document.querySelectorAll("#student-table thead th")[2].innerText = "Oda";
        tbody.innerHTML = "";
        for (let no in students) {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${no}</td><td>${students[no].password}</td><td>${students[no].room || ""}</td>
            <td>
              <button class="btn-edit" onclick="editStudent('${no}')">Düzenle</button> <button class="btn-edit" onclick="editRoom('${no}')">Oda</button>
              <button class="btn-delete" onclick="deleteStudent('${no}')">Sil</button>
            </td>`;
          tbody.appendChild(row);
        }
      });
    }

    function editStudent(no) {
      const newPass = prompt("Yeni şifre girin:");
      if (newPass) {
        db.ref("students/" + no).set(newPass).then(() => {
          alert("Şifre güncellendi."); loadStudents();
        });
      }
    }

    function deleteStudent(no) {
      if (confirm("Bu öğrenciyi silmek istediğinize emin misiniz?")) {
        db.ref("students/" + no).remove().then(() => {
          alert("Öğrenci silindi."); loadStudents();
        });
      }
    }

    function filterStudentTable() {
      const input = document.getElementById("searchStudent").value.toLowerCase();
      const rows = document.querySelectorAll("#student-table tbody tr");
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(input) ? "" : "none";
      });
    }

    function sortTable(colIndex) {
      const table = document.getElementById("student-table");
      const tbody = table.querySelector("tbody");
      const rows = Array.from(tbody.rows);
      const ascending = table.getAttribute("data-sort") !== "asc";
      rows.sort((a, b) => {
        const valA = a.cells[colIndex].innerText.toLowerCase();
        const valB = b.cells[colIndex].innerText.toLowerCase();
        return ascending ? valA.localeCompare(valB) : valB.localeCompare(valA);
      });
      rows.forEach(row => tbody.appendChild(row));
      table.setAttribute("data-sort", ascending ? "asc" : "desc");
    }

    function login() {
      const no = prompt("Öğrenci Numaranız:");
      const sifre = prompt("Şifreniz:");
      db.ref("students/" + no).once("value").then(snapshot => {
        const user = snapshot.val();
        if (user && user.password === sifre) {
          currentStudentNo = no;
          alert("Giriş başarılı!");
          startApp();
        } else {
          alert("Giriş başarısız.");
        }
      });
    }

    function startApp() {
      db.ref("machines").on("value", (snapshot) => {
        const machines = snapshot.val();
        const container = document.getElementById("machine-list");
        container.innerHTML = "";
        for (let key in machines) {
          const status = machines[key].status;
          const card = document.createElement("div");
          card.className = "card " + status;
          card.innerText = key + " - " + status.replace("_", " ");
          container.appendChild(card);
        }
      });

      
    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText, decodedResult) => {
        checkUsageLimitAndProceed(decodedText);
        html5QrCode.stop();
        document.getElementById("reader").innerHTML = "<p>QR okutuldu. Kamera kapatıldı.</p>";
      },
      (errorMessage) => {}
    ).catch(err => {
      document.getElementById("reader").innerText = "Kamera başlatılamadı.";
    });
    
    }

    function checkUsageLimitAndProceed(machineId) {
      const now = Date.now();
      const oneWeekAgo = now - (7 * 24 * 60 * 60 * 1000);
      db.ref("usage_logs/" + currentStudentNo).once("value").then(snapshot => {
        const logs = snapshot.val() || {};
        let recentUsageCount = 0;
        for (let key in logs) if (parseInt(key) > oneWeekAgo) recentUsageCount++;
        if (recentUsageCount < 4) {
          toggleMachineStatus(machineId);
          db.ref("usage_logs/" + currentStudentNo + "/" + now).set(true);
        } else {
          alert("Kullanım hakkınızı doldurdunuz.");
        }
      });
    }

    function toggleMachineStatus(machineId) {
      const ref = db.ref("machines/" + machineId + "/status");
      ref.once("value").then((snap) => {
        const current = snap.val();
        const newStatus = current === "available" ? "in_use" : "available";
        ref.set(newStatus);
        db.ref("machines/" + machineId + "/last_status_change_time").set(Date.now());
        db.ref("logs").push({
          machine: machineId,
          action: newStatus,
          student_no: currentStudentNo,
          ip: currentStudentIp,
          time: new Date().toISOString()
        });
        document.getElementById("reader").innerHTML = "<p>QR okutuldu. Kamera kapatıldı.</p>";
      });
    }

    function loadLogs() {
      db.ref("logs").limitToLast(100).once("value").then(snapshot => {
        const logs = snapshot.val() || {};
        const tbody = document.querySelector("#log-table tbody");
        tbody.innerHTML = "";
        const entries = Object.entries(logs).reverse();
        entries.forEach(([key, log]) => {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${log.machine}</td><td>${log.action}</td><td>${log.student_no}</td><td>${log.ip}</td><td>${new Date(log.time).toLocaleString()}</td>`;
          tbody.appendChild(row);
        });
      });
    }

    function loadUsageStats() {
      const now = Date.now();
      const oneWeekAgo = now - (7 * 24 * 60 * 60 * 1000);
      db.ref("usage_logs").once("value").then(snapshot => {
        const logs = snapshot.val() || {};
        const tbody = document.querySelector("#usage-table tbody");
        tbody.innerHTML = "";
        for (let student in logs) {
          let count = 0;
          for (let time in logs[student]) if (parseInt(time) > oneWeekAgo) count++;
          const row = document.createElement("tr");
          row.innerHTML = `<td>${student}</td><td>${count}</td>`;
          tbody.appendChild(row);
        }
      });
    }

    login();
  
    function editRoom(no) {
      const newRoom = prompt("Yeni oda numarası girin:");
      if (newRoom) {
        db.ref("students/" + no + "/room").set(newRoom).then(() => {
          alert("Oda numarası güncellendi.");
          loadStudents();
        });
      }
    }
  </script>

</body>
</html>

<script>
    // Otomatik timeout kontrolü (her 5 dakikada bir)
    setInterval(() => {
      const now = Date.now();
      db.ref("machines").once("value").then(snapshot => {
        const machines = snapshot.val() || {};
        for (let key in machines) {
          const status = machines[key].status;
          const lastChange = machines[key].last_status_change_time || now;
          if (status === "in_use" && (now - lastChange > 1 * 60 * 1000)) {
            db.ref("machines/" + key + "/status").set("timeout");
          }
        }
      });
    }, 5 * 60 * 1000); // 5 dakika
</script>
